<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="css/styles.css">

        <!-- Matomo -->
        <script type="text/javascript">
            var _paq = window._paq || [];
            /* tracker methods like "setCustomDimension" should be called before "trackPageView" */
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function() {
            var u="https://matomo.axvigs.com/";
            _paq.push(['setTrackerUrl', u+'matomo.php']);
            _paq.push(['setSiteId', '3']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
            })();
        </script>
        <!-- End Matomo Code -->

    </head>
    <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>
    <script src="js/LoadData.js"></script>
    <script src="js/moment.js"></script>
    <script>

        function start() {
            document.getElementById("status").innerHTML = "Loading data";
            loadAllData()
                .then(function() {
                    getLocation();
                });
        }

        function getLocation() {
            document.getElementById("status").innerHTML = "Getting location";
            var options = {
                enableHighAccuracy: true,
                timeout: 20000,
                maximumAge: 10000
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError, options);
            } 
            else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            
            document.getElementById("status").innerHTML = "Running calculations";

            var currentLocation = turf.point([position.coords.longitude, position.coords.latitude]);
            
            // 0.3 miles from AICW 6
            //var currentLocation = turf.point([-76.2932567,36.7960833]);
            
            var nearest = turf.nearestPoint(currentLocation, data);

            document.getElementById("latitude").innerHTML = position.coords.latitude.toFixed(5); 
            document.getElementById("longitude").innerHTML = position.coords.longitude.toFixed(5); 
            document.getElementById("nearest").innerHTML = nearest.properties.name;
            document.getElementById("distance").innerHTML = (nearest.properties.distanceToPoint / 1.852).toFixed(2) + " nautical miles";
            document.getElementById("distance").innerHTML = (nearest.properties.distanceToPoint / 1.852).toFixed(2) + " nautical miles";
            var now = new moment();
            document.getElementById("status").innerHTML = "Updated at " + now.format("HH:mm:ss");
        }

        function showError(error) {
            switch(error.code) {
                case error.PERMISSION_DENIED:
                x.innerHTML = "User denied the request for geolocation."
                break;
                case error.POSITION_UNAVAILABLE:
                x.innerHTML = "Location information is unavailable."
                break;
                case error.TIMEOUT:
                x.innerHTML = "The request to get user location timed out."
                break;
                case error.UNKNOWN_ERROR:
                x.innerHTML = "An unknown error occurred."
                break;
            }
        } 

    </script>
    <body onload="start()">
        <nav class="menu">
            <ul>
                <li>Main</li>
                <li><a href="about.html">About</a></li>
                <li><a href="data.html">Data</a></li>
            </ul>
        </nav>
        <div style='border: 3px solid black; border-radius: 10px; text-align: center; display: inline-block; padding: 10px'>
            <h2>Nearest marker</h2>
            <h1 id="nearest"></h1>
        </div>
        <table>
            <tr>
                <td>Status:</td>
                <td id="status"></td>
            </tr>
            <tr>
                <td>My latitude:</td>
                <td id="latitude"></td>
            </tr>
            <tr>
                <td>My longitude:</td>
                <td id="longitude"></td>
            </tr>
            <tr>
                <td>My position accuracy:</td>
                <td id="accuracy"></td>
            </tr>
            <tr>
                <td>Distance to nearest mile mark:</td>
                <td id="distance"></td>
            </tr>
        </table>
    </body>
</html>